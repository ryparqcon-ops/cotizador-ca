<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casa Austin - Consulta de Disponibilidad</title>
    <meta name="description" content="Consulta de disponibilidad de casas de playa Casa Austin. Reserva tu escapada perfecta en Los Pulpos.">
    <meta name="keywords" content="casa austin, playa, alquiler, casas, disponibilidad, reservas">
    <meta name="author" content="Casa Austin">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://consulta-disponibilidad.vercel.app/">
    <meta property="og:title" content="Casa Austin - Consulta de Disponibilidad">
    <meta property="og:description" content="Consulta de disponibilidad de casas de playa Casa Austin. Reserva tu escapada perfecta en Los Pulpos.">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://consulta-disponibilidad.vercel.app/">
    <meta property="twitter:title" content="Casa Austin - Consulta de Disponibilidad">
    <meta property="twitter:description" content="Consulta de disponibilidad de casas de playa Casa Austin. Reserva tu escapada perfecta en Los Pulpos.">
    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/daterangepicker.css">
    <link rel="stylesheet" href="styles/style.css">
    <link rel="icon" type="image/png" href="assets/icon_512.png">
</head>
<body>
    <div class="container">
        <h2 class="text-center">Consulta de Disponibilidad</h2>
        <div class="row">
            <div class="col-md-6 offset-md-3">
                <div class="form-group">
                    <label for="fechas">Seleccione un rango de fechas:</label>
                    <input type="text" class="form-control" id="fechas" name="fechas" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="estiloMensaje">Estilo del Mensaje:</label>
                    <select id="estiloMensaje" class="form-control">
                        <option value="1">Premium</option>
                        <option value="2">Urgencia</option>
                        <option value="3">Emocional</option>
                        <option value="4">Valor</option>
                        <option value="5">Simple</option>
                    </select>
                    <div id="descripcionEstilo" style="margin-top:8px; font-size:0.95em; color:#555;"></div>
                </div>
                <div id="input-container">
                    <div class="input-group">
                        <label for="personas">N¬∞ de personas:</label>
                        <input type="number" id="personas" name="personas" class="custom-input" min="1" value="2">
                    </div>
                    <div class="input-group">
                        <label for="tipoCambio">T.C:</label>
                        <input type="number" id="tipoCambio" name="tipoCambio" step="0.01" class="custom-input" value="3.6">
                    </div>
                </div>
                <div class="form-group">
                    <label>Tipo de Descuento (opcional):</label>
                    <div class="form-check-container">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="aplicarDescuentoBase" value="base">
                            <label class="form-check-label" for="aplicarDescuentoBase">Descuento Base</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="aplicarDescuentoTotal" value="total">
                            <label class="form-check-label" for="aplicarDescuentoTotal">Descuento Total</label>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-primary btn-block" id="btnConsultar">Consultar</button>
            </div>
        </div>
        <div id="resultadoContainer" class="row" style="display: none;">
            <div class="col-md-8 offset-md-2">
                <div class="form-group">
                    <label for="textoResultado">Mensaje generado:</label>
                    <textarea id="textoResultado" class="form-control" rows="15" readonly></textarea>
                </div>
                <button type="button" class="btn btn-success" id="btnCopiar">Copiar al Portapapeles</button>
                <button type="button" class="btn btn-secondary" id="btnLimpiar">Limpiar</button>
            </div>
        </div>
        <div id="btnCopiarFlotante" class="btn-flotante" style="display: none;">
            <button type="button" class="btn btn-success btn-sm" id="btnCopiarFlotanteBtn">üìã Copiar</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="assets/moment.min.js"></script>
    <script src="assets/daterangepicker.min.js"></script>
    <script src="assets/es.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <script>
        // Configuraci√≥n inicial
        const tipoCambio = 3.6;
        const numPersonas = 2;
        const apiEndpoint = 'https://casaaustin.pe/api/landing-precios.php';

        // Inicializar DateRangePicker
        $(document).ready(function() {
            $('#fechas').daterangepicker({
                locale: {
                    format: 'YYYY-MM-DD',
                    separator: ' - ',
                    applyLabel: 'Aplicar',
                    cancelLabel: 'Cancelar',
                    fromLabel: 'Desde',
                    toLabel: 'Hasta',
                    customRangeLabel: 'Personalizado',
                    weekLabel: 'S',
                    daysOfWeek: ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sa'],
                    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
                    firstDay: 1
                },
                startDate: moment(),
                endDate: moment().add(1, 'day'),
                minDate: moment(),
                opens: 'left'
            });

            // Configurar valores por defecto
            $('#personas').val(numPersonas);
            $('#tipoCambio').val(tipoCambio);

            // Mostrar descripci√≥n del estilo seleccionado
            const descripciones = {
                '1': 'Enfoque en exclusividad y comodidad. Lenguaje sofisticado y elegante.',
                '2': 'Crea sentido de escasez. Lenguaje de acci√≥n inmediata.',
                '3': 'Conecta con experiencia de playa. Lenguaje evocativo y atractivo.',
                '4': 'Destaca relaci√≥n precio-calidad. Enfoque en beneficios pr√°cticos.',
                '5': 'Comunicaci√≥n directa y clara. Lenguaje simple y accesible.'
            };

            function actualizarDescripcion() {
                const estilo = $('#estiloMensaje').val();
                $('#descripcionEstilo').text(descripciones[estilo]);
            }

            $('#estiloMensaje').change(actualizarDescripcion);
            actualizarDescripcion();

            // Event listeners
            $('#btnConsultar').click(consultarDisponibilidad);
            $('#btnCopiar').click(copiarTexto);
            $('#btnCopiarFlotanteBtn').click(copiarTexto);
            $('#btnLimpiar').click(limpiarResultado);
        });

        // Funci√≥n para consultar disponibilidad
        async function consultarDisponibilidad() {
            const fechas = $('#fechas').val();
            if (!fechas) {
                alert('Por favor seleccione un rango de fechas');
                return;
            }

            const [fechaInicio, fechaFin] = fechas.split(' - ');
            const numPersonas = parseInt($('#personas').val()) || 2;
            const tipoCambio = parseFloat($('#tipoCambio').val()) || 3.6;
            const estiloMensaje = $('#estiloMensaje').val();
            const aplicarDescuentoBase = $('#aplicarDescuentoBase').is(':checked');
            const aplicarDescuentoTotal = $('#aplicarDescuentoTotal').is(':checked');

            // Mostrar loading
            $('#btnConsultar').prop('disabled', true).text('Consultando...');

            try {
                const data = {
                    start_date: fechaInicio,
                    end_date: fechaFin,
                    num_personas: numPersonas,
                    tipo_cambio: tipoCambio,
                    detalles_disponibilidad: 1
                };

                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const responseData = await response.json();
                const respObj = responseData;

                if (respObj.error) {
                    throw new Error(respObj.message || 'Error en la consulta');
                }

                // Procesar respuesta
                const resultadoTexto = $('#textoResultado');
                resultadoTexto.val('');
                const startDateFormatted = moment(fechaInicio).format('dddd D');
                const endDateFormatted = moment(fechaFin).format('dddd D [de] MMMM');
                let mensaje = "";
                let precios = respObj.message2 ? respObj.message2.trim() : "";
                
                // Convertir precios USD a soles si es necesario
                if (precios && tipoCambio) {
                    // Buscar patrones de precios USD y convertirlos a soles
                    precios = precios.replace(/\$(\d+)\s*USD/g, (match, precioUSD) => {
                        const precioSoles = Math.round(parseInt(precioUSD) * tipoCambio);
                        return `S/ ${precioSoles} ($${precioUSD} USD)`;
                    });
                }
                const fotosLink = `https://casaaustin.pe/disponibilidad?checkIn=${fechaInicio}&checkOut=${fechaFin}`;
                const notaCasa1 = "";
                const notaImportante = "*IMPORTANTE: En Casa Austin, consideramos persona adicional a cualquier visitante, sin distinci√≥n si es por el d√≠a o la noche. Por favor, aseg√∫rate de indicar el n√∫mero exacto de personas que ingresar√°n a la casa.*";
                const horario = "*HORARIO: Ingreso desde las 3 y salida es hasta las 11 a.m.*";

                let casa1Disponible = false;
                if (Array.isArray(respObj.casasDisponibles)) {
                    casa1Disponible = respObj.casasDisponibles.some(
                        casa => casa.idCasa === 1
                    );
                }

                // Verificar si las fechas son de lunes a jueves y el mes es de mayo a noviembre
                const startMoment = moment(fechaInicio, 'YYYY-MM-DD');
                const endMoment = moment(fechaFin, 'YYYY-MM-DD');
                const esLunesAJueves = startMoment.day() >= 1 && startMoment.day() <= 4 && endMoment.day() >= 1 && endMoment.day() <= 4;
                const esMesMayoANoviembre = (startMoment.month() + 1) >= 5 && (startMoment.month() + 1) <= 11;
                const mostrarDatoClaveCasa1 = false; // Deshabilitado seg√∫n solicitud

                let leyendaDescuento = "";
                if (aplicarDescuentoBase) {
                    leyendaDescuento += "üéÅ *Descuento especial aplicado*\n";
                }
                if (aplicarDescuentoTotal) {
                    leyendaDescuento += "üéÅ *Descuento total aplicado*\n";
                }

                // Generar mensaje seg√∫n disponibilidad
                if (respObj.estadoDisponibilidad === 1) {
                    // Casas disponibles - generar mensaje seg√∫n estilo
                    switch(estiloMensaje) {
                        case '1': // Premium
                            mensaje = `üèñÔ∏è *¬°CONFIRMADO! UNA ESCAPADA PREMIUM TE ESPERA*\nüìÖ *Del ${startDateFormatted} al ${endDateFormatted}*\n\n‚ú® *${respObj.casasDisponibles ? respObj.casasDisponibles.length : 0} casas disponibles para quienes valoran comodidad, privacidad y estilo*\n\nüíµ *Tarifas para ${numPersonas} personas:*\n${precios}\n\nüìç *Playa Los Pulpos ‚Äì A solo 20 minutos del Jockey Plaza*\nüïí *Check-in: 3:00 PM | üïö Check-out: 11:00 AM*\n\nüì∏ *Reserva aqu√≠ ‚Üí* ${fotosLink}\n\nüéÅ *Beneficios exclusivos por reservar en nuestra web:*\n‚Ä¢ 5% de puntos en cada reserva\n‚Ä¢ Beneficios especiales para miembros de Casa Austin\n‚Ä¢ Atenci√≥n personalizada\n\nüåä *Asegura tu estad√≠a hoy mismo y disfruta de una experiencia exclusiva junto al mar.*`;
                            break;
                        case '2': // Urgencia
                            mensaje = `‚ö° *¬°√öLTIMAS FECHAS DISPONIBLES!*\nüìÖ *Del ${startDateFormatted} al ${endDateFormatted}*\n\nüî• *Solo quedan ${respObj.casasDisponibles ? respObj.casasDisponibles.length : 0} opciones para estas fechas*\n\nüíµ *Tarifas para ${numPersonas} personas:*\n${precios}\n\nüìç *Playa Los Pulpos ‚Äì A solo 20 minutos del Jockey Plaza*\nüïí *Check-in: 3:00 PM | üïö Check-out: 11:00 AM*\n\nüì∏ *Reserva aqu√≠ ‚Üí* ${fotosLink}\n\nüéÅ *Beneficios exclusivos por reservar en nuestra web:*\n‚Ä¢ 5% de puntos en cada reserva\n‚Ä¢ Beneficios especiales para miembros de Casa Austin\n‚Ä¢ Atenci√≥n personalizada\n\n‚ö° *¬°No pierdas esta oportunidad! Reserva ahora antes de que se agoten.*`;
                            break;
                        case '3': // Emocional
                            mensaje = `üåä *¬°Tu escapada perfecta te est√° esperando!*\nüìÖ *Del ${startDateFormatted} al ${endDateFormatted}*\n\nüèñÔ∏è *Disfruta del mar y la tranquilidad en nuestras ${respObj.casasDisponibles ? respObj.casasDisponibles.length : 0} casas exclusivas*\n\nüíµ *Tarifas para ${numPersonas} personas:*\n${precios}\n\nüìç *Playa Los Pulpos ‚Äì A solo 20 minutos del Jockey Plaza*\nüïí *Check-in: 3:00 PM | üïö Check-out: 11:00 AM*\n\nüì∏ *Reserva aqu√≠ ‚Üí* ${fotosLink}\n\nüéÅ *Beneficios exclusivos por reservar en nuestra web:*\n‚Ä¢ 5% de puntos en cada reserva\n‚Ä¢ Beneficios especiales para miembros de Casa Austin\n‚Ä¢ Atenci√≥n personalizada\n\nüåÖ *Despierta con el sonido del mar y vive una experiencia inolvidable.*`;
                            break;
                        case '4': // Valor
                            mensaje = `üí∞ *¬°Excelente relaci√≥n precio-calidad!*\nüìÖ *Del ${startDateFormatted} al ${endDateFormatted}*\n\nüè† *Casas independientes con todas las comodidades - ${respObj.casasDisponibles ? respObj.casasDisponibles.length : 0} opciones disponibles*\n\nüíµ *Tarifas para ${numPersonas} personas:*\n${precios}\n\nüìç *Playa Los Pulpos ‚Äì A solo 20 minutos del Jockey Plaza*\nüïí *Check-in: 3:00 PM | üïö Check-out: 11:00 AM*\n\nüì∏ *Reserva aqu√≠ ‚Üí* ${fotosLink}\n\nüéÅ *Beneficios exclusivos por reservar en nuestra web:*\n‚Ä¢ 5% de puntos en cada reserva\n‚Ä¢ Beneficios especiales para miembros de Casa Austin\n‚Ä¢ Atenci√≥n personalizada\n\nüí° *La mejor inversi√≥n para tu descanso y diversi√≥n.*`;
                            break;
                        case '5': // Simple
                            mensaje = `üìÖ *Consulta de Disponibilidad*\nüìÖ *Del ${startDateFormatted} al ${endDateFormatted}*\n\n‚úÖ *Casas disponibles para las fechas seleccionadas*\n\nüíµ *Tarifas para ${numPersonas} personas:*\n${precios}\n\nüìç *Playa Los Pulpos ‚Äì A solo 20 minutos del Jockey Plaza*\nüïí *Check-in: 3:00 PM | üïö Check-out: 11:00 AM*\n\nüì∏ *Reserva aqu√≠ ‚Üí* ${fotosLink}\n\nüéÅ *Beneficios exclusivos por reservar en nuestra web:*\n‚Ä¢ 5% de puntos en cada reserva\n‚Ä¢ Beneficios especiales para miembros de Casa Austin\n‚Ä¢ Atenci√≥n personalizada`;
                            break;
                    }
                } else {
                    // No hay disponibilidad - buscar fechas alternativas
                    await verificarFechasAlternativas(fechaInicio, fechaFin, numPersonas, tipoCambio, estiloMensaje, fotosLink);
                    return;
                }

                const textoFinal = `${mensaje}\n\n${leyendaDescuento}${notaCasa1}${notaImportante}\n\n${horario}`;
                resultadoTexto.val(textoFinal);
                $('#resultadoContainer').show();
                $('#btnCopiarFlotante').show();

            } catch (error) {
                console.error('Error:', error);
                alert('Error al consultar disponibilidad: ' + error.message);
            } finally {
                $('#btnConsultar').prop('disabled', false).text('Consultar');
            }
        }

        // Funci√≥n para verificar fechas alternativas
        async function verificarFechasAlternativas(fechaInicio, fechaFin, numPersonas, tipoCambio, estiloMensaje, fotosLink) {
            try {
                // Calcular fechas alternativas manteniendo el mismo rango de fechas
                const fechaInicioMoment = moment(fechaInicio, 'YYYY-MM-DD');
                const fechaFinMoment = moment(fechaFin, 'YYYY-MM-DD');
                
                // Calcular n√∫mero de noches del rango original
                const numeroNoches = fechaFinMoment.diff(fechaInicioMoment, 'days');
                
                // Generar solo 1 fecha antes y 1 fecha despu√©s
                const alternativas = [];
                
                // Fecha anterior (1 d√≠a antes)
                const fechaAnteriorInicio = fechaInicioMoment.clone().subtract(1, 'day').format('YYYY-MM-DD');
                const fechaAnteriorFin = fechaInicioMoment.clone().subtract(1, 'day').add(numeroNoches, 'days').format('YYYY-MM-DD');
                
                // Fecha posterior (1 d√≠a despu√©s)
                const fechaPosteriorInicio = fechaInicioMoment.clone().add(1, 'day').format('YYYY-MM-DD');
                const fechaPosteriorFin = fechaInicioMoment.clone().add(1, 'day').add(numeroNoches, 'days').format('YYYY-MM-DD');
                
                // Verificar disponibilidad para fecha anterior
                const dataAnterior = {
                    start_date: fechaAnteriorInicio,
                    end_date: fechaAnteriorFin,
                    num_personas: numPersonas,
                    tipo_cambio: tipoCambio,
                    detalles_disponibilidad: 1
                };
                
                const responseAnterior = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataAnterior)
                });
                const respAnterior = await responseAnterior.json();
                
                if (respAnterior.estadoDisponibilidad === 1) {
                    const preciosAnterior = respAnterior.message2 ? respAnterior.message2.trim() : "";
                    const preciosConvertidos = preciosAnterior.replace(/\$(\d+)\s*USD/g, (match, precioUSD) => {
                        const precioSoles = Math.round(parseInt(precioUSD) * tipoCambio);
                        return `Casa ${precioUSD === '65' ? '1' : precioUSD === '85' ? '2' : '3'}: $${precioUSD} D√≥lares √≥ S/.${precioSoles}.00 Soles`;
                    });
                    
                    alternativas.push({
                        fechaInicio: fechaAnteriorInicio,
                        fechaFin: fechaAnteriorFin,
                        precios: preciosConvertidos,
                        tipo: 'anterior'
                    });
                }
                
                // Verificar disponibilidad para fecha posterior
                const dataPosterior = {
                    start_date: fechaPosteriorInicio,
                    end_date: fechaPosteriorFin,
                    num_personas: numPersonas,
                    tipo_cambio: tipoCambio,
                    detalles_disponibilidad: 1
                };
                
                const responsePosterior = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataPosterior)
                });
                const respPosterior = await responsePosterior.json();
                
                if (respPosterior.estadoDisponibilidad === 1) {
                    const preciosPosterior = respPosterior.message2 ? respPosterior.message2.trim() : "";
                    const preciosConvertidos = preciosPosterior.replace(/\$(\d+)\s*USD/g, (match, precioUSD) => {
                        const precioSoles = Math.round(parseInt(precioUSD) * tipoCambio);
                        return `Casa ${precioUSD === '65' ? '1' : precioUSD === '85' ? '2' : '3'}: $${precioUSD} D√≥lares √≥ S/.${precioSoles}.00 Soles`;
                    });
                    
                    alternativas.push({
                        fechaInicio: fechaPosteriorInicio,
                        fechaFin: fechaPosteriorFin,
                        precios: preciosConvertidos,
                        tipo: 'posterior'
                    });
                }
                
                // Generar mensaje con alternativas
                let mensajeAlternativas = `üìÖ *Consulta de Disponibilidad*\nüìÖ *Del ${moment(fechaInicio).format('dddd D')} al ${moment(fechaFin).format('dddd D [de] MMMM')}* (${numeroNoches} ${numeroNoches === 1 ? 'noche' : 'noches'})\n\n‚ö†Ô∏è *Estas fechas no est√°n disponibles*\n\n`;
                
                if (alternativas.length > 0) {
                    // Ordenar alternativas por fecha
                    alternativas.sort((a, b) => moment(a.fechaInicio).diff(moment(b.fechaInicio)));
                    
                    const alternativasFormateadas = alternativas.map(alt => {
                        const fechaInicioFormateada = moment(alt.fechaInicio).format('dddd D');
                        const fechaFinFormateada = moment(alt.fechaFin).format('dddd D [de] MMMM');
                        const enlace = `https://casaaustin.pe/disponibilidad?checkIn=${alt.fechaInicio}&checkOut=${alt.fechaFin}`;
                        
                        return `‚úÖ *${fechaInicioFormateada} al ${fechaFinFormateada}* - DISPONIBLE\n${alt.precios}\n\n${enlace}`;
                    });
                    
                    mensajeAlternativas += `üéÅ *¬°Tenemos fechas alternativas disponibles!*\n\n${alternativasFormateadas.join('\n\n')}\n\nüí¨ *¬øPrefieres otras fechas? Responde este mensaje y te ofrecemos un descuento especial para fechas personalizadas.*`;
                } else {
                    mensajeAlternativas += `üòî *Lamentablemente tampoco tenemos disponibilidad para fechas cercanas*\n\nüéÅ *¬°Pero tenemos una oferta especial para ti!*\n‚Ä¢ Responde este mensaje y te ofrecemos un descuento especial\n‚Ä¢ Fechas personalizadas con precios preferenciales\n‚Ä¢ Atenci√≥n directa para encontrar la mejor opci√≥n\n\nüì± *Cont√°ctanos para m√°s opciones:* ${fotosLink}`;
                }
                
                $('#resultadoContainer').show();
                $('#btnCopiarFlotante').show();
                $('#textoResultado').val(mensajeAlternativas);
                
            } catch (error) {
                console.error('Error verificando fechas alternativas:', error);
                // Mostrar mensaje de error simple
                const mensajeError = `üìÖ *Consulta de Disponibilidad*\nüìÖ *Del ${moment(fechaInicio).format('dddd D')} al ${moment(fechaFin).format('dddd D [de] MMMM')}*\n\n‚ö†Ô∏è *Estas fechas no est√°n disponibles*\n\nüì± *Cont√°ctanos para m√°s opciones:* ${fotosLink}`;
                $('#resultadoContainer').show();
                $('#btnCopiarFlotante').show();
                $('#textoResultado').val(mensajeError);
            }
        }

        // Funci√≥n para copiar texto
        function copiarTexto() {
            const texto = $('#textoResultado').val();
            if (navigator.clipboard) {
                navigator.clipboard.writeText(texto).then(function() {
                    alert('Texto copiado al portapapeles');
                });
            } else {
                // Fallback para navegadores m√°s antiguos
                const textArea = document.createElement('textarea');
                textArea.value = texto;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Texto copiado al portapapeles');
            }
        }

        // Funci√≥n para limpiar resultado
        function limpiarResultado() {
            $('#textoResultado').val('');
            $('#resultadoContainer').hide();
            $('#btnCopiarFlotante').hide();
        }
    </script>
</body>
</html>

